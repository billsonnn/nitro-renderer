import { IMessageDataWrapper, IMessageParser } from '@/api'
import { TalentTrackLevel } from '@/nitro'
import { TalentTrackRewardProduct } from '@/nitro'
import { TalentTrackTask } from '@/nitro'

export class TalentTrackParser implements IMessageParser {
  private _type: string

  public get type(): string {
    return this._type
  }

  private _levels: TalentTrackLevel[]

  public get levels(): TalentTrackLevel[] {
    return this._levels
  }

  public flush(): boolean {
    this._type = null
    this._levels = null

    return true
  }

  public parse(wrapper: IMessageDataWrapper): boolean {
    if (!wrapper) return false

    this._type = wrapper.readString()

    this._levels = []
    const levelsCount = wrapper.readInt()

    for (let i = 0; i < levelsCount; i++) {
      const levelId = wrapper.readInt()
      const levelState = wrapper.readInt()

      const levelAchievements: TalentTrackTask[] = []
      const achievementsCount = wrapper.readInt()

      for (let j = 0; j < achievementsCount; j++) {
        const id = wrapper.readInt()
        const index = wrapper.readInt()
        const code = wrapper.readString()
        const state = wrapper.readInt()
        const progress = wrapper.readInt()
        const achievementProgress = wrapper.readInt()

        levelAchievements.push(new TalentTrackTask(id, index, code, state, progress, achievementProgress))
      }

      const levelPerks: string[] = []
      const perksCount = wrapper.readInt()

      for (let j = 0; j < perksCount; j++) levelPerks.push(wrapper.readString())

      const levelItems: TalentTrackRewardProduct[] = []
      const itemsCount = wrapper.readInt()

      for (let j = 0; j < itemsCount; j++) {
        const name = wrapper.readString()
        const unknownInt = wrapper.readInt()

        levelItems.push(new TalentTrackRewardProduct(name, unknownInt))
      }

      this._levels.push(new TalentTrackLevel(levelId, levelState, levelAchievements, levelPerks, levelItems))
    }

    return true
  }
}
